From 00770b5f8de9ee16939b2a59119a86715d3d5ba6 Mon Sep 17 00:00:00 2001
From: Ritaro Takenaka <ritarot634@gmail.com>
Date: Sun, 4 Sep 2022 20:32:22 +0900
Subject: [PATCH 1/4] flow offload fix padding

---
 net/netfilter/nf_flow_table_ip.c | 10 +++++++---
 1 file changed, 7 insertions(+), 3 deletions(-)

--- a/net/netfilter/nf_flow_table_ip.c
+++ b/net/netfilter/nf_flow_table_ip.c
@@ -29,7 +29,7 @@ static int nf_flow_state_check(struct fl
 		return 0;
 
 	tcph = (void *)(skb_network_header(skb) + thoff);
-	if (unlikely(tcph->fin || tcph->rst)) {
+	if (tcph->syn || tcph->fin || tcph->rst) {
 		flow_offload_teardown(flow);
 		return -1;
 	}
@@ -339,7 +339,7 @@ nf_flow_offload_ip_hook(void *priv, stru
 {
 	struct flow_offload_tuple_rhash *tuplehash;
 	struct nf_flowtable *flow_table = priv;
-	struct flow_offload_tuple tuple = {};
+	struct flow_offload_tuple tuple;
 	enum flow_offload_tuple_dir dir;
 	struct flow_offload *flow;
 	struct net_device *outdev;
@@ -350,6 +350,8 @@ nf_flow_offload_ip_hook(void *priv, stru
 	__be32 nexthop;
 	int ret;
 
+	memset(&tuple, 0, sizeof(tuple));
+
 	if (skb->protocol != htons(ETH_P_IP) &&
 	    !nf_flow_skb_encap_protocol(skb, htons(ETH_P_IP), &offset))
 		return NF_ACCEPT;
@@ -580,7 +582,7 @@ nf_flow_offload_ipv6_hook(void *priv, st
 {
 	struct flow_offload_tuple_rhash *tuplehash;
 	struct nf_flowtable *flow_table = priv;
-	struct flow_offload_tuple tuple = {};
+	struct flow_offload_tuple tuple;
 	enum flow_offload_tuple_dir dir;
 	const struct in6_addr *nexthop;
 	struct flow_offload *flow;
@@ -591,6 +593,8 @@ nf_flow_offload_ipv6_hook(void *priv, st
 	struct rt6_info *rt;
 	int ret;
 
+	memset(&tuple, 0, sizeof(tuple));
+
 	if (skb->protocol != htons(ETH_P_IPV6) &&
 	    !nf_flow_skb_encap_protocol(skb, htons(ETH_P_IPV6), &offset))
 		return NF_ACCEPT;
