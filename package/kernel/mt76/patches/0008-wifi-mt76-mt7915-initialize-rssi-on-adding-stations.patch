From a238df940d6ff63436bdca72127936d3580c5bc7 Mon Sep 17 00:00:00 2001
From: Felix Fietkau <nbd@nbd.name>
Date: Sat, 9 Mar 2024 17:44:42 +0100
Subject: [PATCH 01/11] wifi: mt76: mt7915: initialize rssi on adding stations

Improves initial rate selection after connecting

Signed-off-by: Felix Fietkau <nbd@nbd.name>
---
 mt7915/main.c | 4 ++++
 1 file changed, 4 insertions(+)

--- a/mt7915/main.c
+++ b/mt7915/main.c
@@ -742,6 +742,7 @@ int mt7915_mac_sta_add(struct mt76_dev *
 	struct mt7915_vif *mvif = (struct mt7915_vif *)vif->drv_priv;
 	bool ext_phy = mvif->phy != &dev->phy;
 	int ret, idx;
+	u32 addr;
 
 	idx = mt76_wcid_alloc(dev->mt76.wcid_mask, MT7915_WTBL_STA);
 	if (idx < 0)
@@ -765,6 +766,9 @@ int mt7915_mac_sta_add(struct mt76_dev *
 	if (ret)
 		return ret;
 
+	addr = mt7915_mac_wtbl_lmac_addr(dev, msta->wcid.idx, 30);
+	mt76_rmw_field(dev, addr, GENMASK(7, 0), 0xa0);
+
 	return mt7915_mcu_add_rate_ctrl(dev, vif, sta, false);
 }
 
